I"Ól<h1 id="refactorizaci√≥n-utilizando-pruebas-de-software-en-frontend">Refactorizaci√≥n utilizando pruebas de software en Frontend</h1>
<p>Continuamos caracterizando la aplicaci√≥n para refactorizar y dejar la aplicaci√≥n m√°s flexible y mantenible.</p>

<p>A diferencia de las pruebas que escribimos para el Backend, nuestra parte Frontend utiliza el framework VueJS y algunos plugins como Vuex y Vuetify. Esto agrega m√°s de dificultad al momento de escribir las pruebas dado que debemos simular en cada una de ellas como si una aplicaci√≥n Vue real estuviera funcionando incluyendo todas las cosas que configuramos.
Para facilitar las cosas Vue ya trae integrada una librer√≠a llamada <code class="language-plaintext highlighter-rouge">@vue/test-utils</code> que nos permitir√° hacer algunas cosas necesarias para ejecutar las pruebas. Si quieres aprender mucho m√°s en profundidad como funciona y que cosas se pueden hacer puedes revisar <a href="https://github.com/vuejs/vue-test-utils/">este enlace</a></p>

<p>Vuetify al ser una de las librer√≠as que m√°s usamos debido a que est√° incluida en todas las vistas de nuestra aplicaci√≥n, necesita de una configuraci√≥n especial para funcionar. El detalle y varios ejemplos de como hacer esto lo puedes revisar en la <a href="https://vuetifyjs.com/en/getting-started/unit-testing/">secci√≥n dedicada a pruebas de software de la documentaci√≥n de Vuetify</a></p>

<p>En resumen debemos configurar las pruebas para que se incluya globalmente en cada prueba. 
Tenemos que hacer dos pasos para esto. El primero es modificar el archivo <code class="language-plaintext highlighter-rouge">frontend/jest.config.js</code> para que quede as√≠:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">preset</span><span class="p">:</span> <span class="dl">'</span><span class="s1">@vue/cli-plugin-unit-jest</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">setupFilesAfterEnv</span><span class="p">:</span> <span class="p">[</span>
    <span class="dl">'</span><span class="s1">./jest.setup.js</span><span class="dl">'</span>
  <span class="p">]</span>
<span class="p">}</span>

</code></pre></div></div>

<p>A continuaci√≥n hay que crear el archivo <code class="language-plaintext highlighter-rouge">jest.setup.js</code> en la ra√≠z del directorio <code class="language-plaintext highlighter-rouge">frontend</code> con el siguiente contenido</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">Vue</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">vue</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">Vuetify</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">vuetify</span><span class="dl">'</span>

<span class="nx">Vue</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">Vuetify</span><span class="p">)</span>
</code></pre></div></div>

<p>Aprovecharemos de incluir la opci√≥n para analizar la cobertura de las pruebas de software modificando el archivo <code class="language-plaintext highlighter-rouge">package.json</code> en su secci√≥n <code class="language-plaintext highlighter-rouge">scripts</code>:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="dl">"</span><span class="s2">test:unit</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">vue-cli-service test:unit --coverage</span><span class="dl">"</span>
</code></pre></div></div>

<p>Una vez configurado esto comenzaremos a escribir las pruebas.</p>
<h4 id="casos-de-la-funcionalidad-para-definir-pruebas">Casos de la funcionalidad para definir pruebas</h4>
<p>En estos momentos el Frontend cuanta con las siguientes caracter√≠sticas</p>

<ul>
  <li>Una vista <code class="language-plaintext highlighter-rouge">Login</code>  con un formulario con Vuetify que como finalidad ejecutar una funci√≥n <code class="language-plaintext highlighter-rouge">login</code> que a su vez llama al m√©todo de autenticaci√≥n de Firebase. En caso de ser exitoso, se redirige a la p√°gina de productos.</li>
</ul>

<p>El res√∫men de ese c√≥digo lo vemos en la siguiente imagen.
<strong>frontend/views/Login.vue</strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>

<span class="k">async</span> <span class="nx">login</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">validate</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// Caso 1: Para un formulario v√°lido ir a la p√°gina de productos si la autenticaci√≥n fue exitosa</span>
    <span class="k">await</span> <span class="nx">Auth</span><span class="p">.</span><span class="nx">signInWithEmailAndPassword</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Products</span><span class="dl">'</span> <span class="p">})</span>
  <span class="p">}</span>
  <span class="c1">// Caso 2: Para un formulario inv√°lido NO llamamos al m√©todo de autenticaci√≥n</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Tambi√©n tenemos una vista llamada <code class="language-plaintext highlighter-rouge">Products</code> que al montarse en el DOM, invoca una acci√≥n de Vuex que desencadena que se guarde en el estado una variable llamada <code class="language-plaintext highlighter-rouge">products</code> con la lista de productos provenientes del servidor. Cuando este valor del estado se actualiza, nuestra vista reacciona a esto mostrando la lista de elementos.</li>
</ul>

<p>Lo vemos en el siguiente resumen
<strong>frontend/src/views/Products.vue</strong></p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="nx">computed</span><span class="p">:</span> <span class="p">{</span>
<span class="p">...</span><span class="nx">mapState</span><span class="p">([</span>
    <span class="dl">'</span><span class="s1">products</span><span class="dl">'</span>
  <span class="p">])</span>
<span class="p">},</span>
<span class="nx">methods</span><span class="p">:</span> <span class="p">{</span>
  <span class="p">...</span><span class="nx">mapActions</span><span class="p">([</span>
    <span class="dl">'</span><span class="s1">getProducts</span><span class="dl">'</span>
  <span class="p">])</span>
<span class="p">},</span>
<span class="nx">created</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Delegaci√≥n de funcionalidad al store</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">getProducts</span><span class="p">()</span>
<span class="p">}</span>
<span class="p">...</span>
</code></pre></div></div>

<p><strong>frontend/src/store/index.js</strong></p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">actions</span><span class="p">:</span> <span class="p">{</span>
  <span class="k">async</span> <span class="nx">getProducts</span> <span class="p">(</span><span class="nx">actionContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">commit</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">actionContext</span>
    <span class="kd">const</span> <span class="nx">productsURL</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">/api/products</span><span class="dl">'</span>

    <span class="k">try</span> <span class="p">{</span>
    <span class="c1">// Caso 1: Al invocar a la acci√≥n getProducts al inicio de la vista se crea la lista de productos si el servidor responde exitosamente</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Caso 2: Al invocar a la acci√≥n getProducts al inicio de la vista NO se crea la lista de productos si el servidor responde con error</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">...</span>
</code></pre></div></div>

<h4 id="implementaci√≥n-de-pruebas-sobre-la-vista-login">Implementaci√≥n de pruebas sobre la vista Login</h4>
<p>Vamos a escribir las pruebas para los casos que describimos anteriormente.</p>

<h5 id="caso-1-para-un-formulario-v√°lido-ir-a-la-p√°gina-de-productos-si-la-autenticaci√≥n-fue-exitosa">Caso 1: Para un formulario v√°lido ir a la p√°gina de productos si la autenticaci√≥n fue exitosa</h5>

<p>Resultado esperado</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Al resolverse la promesa del m√©todo Auth.signInWithEmailAndPassword llama al m√©todo $router.push 
</code></pre></div></div>

<p>La implementaci√≥n de estas pruebas las escribiremos en un nuevo archivo llamado <code class="language-plaintext highlighter-rouge">Login.spec.js</code> en la carpeta <code class="language-plaintext highlighter-rouge">frontend/tests/unit</code> con el siguiente contenido:</p>

<p><strong>frontend/tests/unit/Login.spec.js</strong></p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">mount</span><span class="p">,</span> <span class="nx">createLocalVue</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@vue/test-utils</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">Vuetify</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">vuetify</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">flushPromises</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">flush-promises</span><span class="dl">'</span>

<span class="k">import</span> <span class="nx">App</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/App.vue</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">store</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/store</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">router</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/router</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Auth</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/firebase</span><span class="dl">'</span>

<span class="nx">jest</span><span class="p">.</span><span class="nx">mock</span><span class="p">(</span><span class="dl">'</span><span class="s1">@/firebase</span><span class="dl">'</span><span class="p">,()</span><span class="o">=&gt;</span> <span class="p">({</span>
  <span class="na">Auth</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">signInWithEmailAndPassword</span><span class="p">:</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}))</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Login.vue</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">localVue</span>
  <span class="kd">let</span> <span class="nx">vuetify</span>

  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">localVue</span> <span class="o">=</span> <span class="nx">createLocalVue</span><span class="p">()</span>
    <span class="nx">vuetify</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Vuetify</span><span class="p">()</span>

    <span class="nx">Auth</span><span class="p">.</span><span class="nx">signInWithEmailAndPassword</span><span class="p">.</span><span class="nx">mockReset</span><span class="p">()</span>
    <span class="nx">router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">Successful login redirects to products page</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">Auth</span><span class="p">.</span><span class="nx">signInWithEmailAndPassword</span><span class="p">.</span><span class="nx">mockResolvedValue</span><span class="p">()</span>
    <span class="kd">const</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="nx">mount</span><span class="p">(</span><span class="nx">App</span><span class="p">,{</span>
      <span class="nx">localVue</span><span class="p">,</span>
      <span class="nx">vuetify</span><span class="p">,</span>
      <span class="nx">store</span><span class="p">,</span>
      <span class="nx">router</span>
    <span class="p">})</span>
    <span class="nx">wrapper</span><span class="p">.</span><span class="nx">vm</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">push</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()</span>
    <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">[data-cy=username]</span><span class="dl">'</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="dl">'</span><span class="s1">testlogin@boolean.cl</span><span class="dl">'</span><span class="p">)</span>
    <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">[data-cy=password]</span><span class="dl">'</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="dl">'</span><span class="s1">somepass</span><span class="dl">'</span><span class="p">)</span>

    <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">[data-cy=login-btn]</span><span class="dl">'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="dl">'</span><span class="s1">click</span><span class="dl">'</span><span class="p">)</span>
    <span class="k">await</span> <span class="nx">flushPromises</span><span class="p">()</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">vm</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">push</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Products</span><span class="dl">'</span> <span class="p">})</span>
  <span class="p">})</span>
<span class="p">})</span>

</code></pre></div></div>

<p>Elimina el <code class="language-plaintext highlighter-rouge">example.spec.js</code> que se creo junto con la aplicaci√≥n. No lo usaremos.</p>

<p>Vemos que incluimos un bloque <code class="language-plaintext highlighter-rouge">beforeEach</code> que nos permitir√° hacer algunas acciones comunes relativas a las pruebas que escribiremos como por ejemplo dobles de prueba para la autenticaci√≥n y su correspondiente <code class="language-plaintext highlighter-rouge">mockReset</code> para as√≠ asegurarnos de cumplir el <a href="http://agileinaflash.blogspot.com/2009/02/first.html">principio FIRST</a> manteniendo a cada una de las pruebas ‚Äúaisladas‚Äù entre si.
Aprovechando que nuestras vistas est√°n integradas con el enrutador de la aplicaci√≥n, realizamos una navegaci√≥n hacia la ruta <code class="language-plaintext highlighter-rouge">/</code> para asegurarnos que cuando la aplicaci√≥n sea montada para las pruebas, se utilice la vista correcta.</p>

<p>Ahora al mirar la prueba vemos como podemos configurar que la promesa asociada que retorna el m√©todo <code class="language-plaintext highlighter-rouge">Auth.signInWithEmailAndPassword</code> se resuelva con ayuda de jest en la funci√≥n <code class="language-plaintext highlighter-rouge">mockResolvedValue</code>, al ser llamada en el contexto de la aplicaci√≥n Vue esta no se resolver√° autom√°ticamente. Para poder lograr esto utilizaremos la librer√≠a <code class="language-plaintext highlighter-rouge">flush-promises</code>.
Podemos ver una explicaci√≥n desde la propia documentaci√≥n de Vue relacionada a esto en <a href="https://vue-test-utils.vuejs.org/guides/testing-async-components.html#asynchronous-behavior-outside-of-vue">este enlace</a></p>

<p>Vamos a instalar esta librer√≠a ejecutando lo siguiente en nuestra terminal preocup√°ndonos de navagar hasta el directorio <code class="language-plaintext highlighter-rouge">frontend</code> en nuestro proyecto:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install</span> <span class="nt">--save-dev</span> flush-promises
</code></pre></div></div>

<p>Ahora ya estamos en condiciones de correr las pruebas que escribimos para la vista <code class="language-plaintext highlighter-rouge">Login.vue</code>. Al correr el comando <code class="language-plaintext highlighter-rouge">npm run test:unit</code> veremos lo siguiente:</p>

<p><img src="images/07-testing-frontend-01.png" alt="Imagen que muestra la ejecuci√≥n de Jest" /></p>

<p>Como vemos remarcado en la imagen a√∫n no hemos abordado todos los casos para esta vista. Si vamos a la carpeta coverage que se debe haber creado en la ra√≠z del directorio <code class="language-plaintext highlighter-rouge">frontend</code> y analizamos el archivo <code class="language-plaintext highlighter-rouge">frontend/src/Login.vue</code> veremos lo siguiente:</p>

<p><img src="images/07-testing-frontend-02.png" alt="Imagen que muestra m√©trica branch no cubierta" /></p>

<p>Esto quiere decir que necesitamos una prueba que cubra el caso en el cual se llama a la funci√≥n <code class="language-plaintext highlighter-rouge">login</code> pero el formulario no es v√°lido.</p>

<p>En adelante vamos a complementar este archivo agregando los bloques <code class="language-plaintext highlighter-rouge">it</code> dentro del bloque <code class="language-plaintext highlighter-rouge">describe</code> en el mismo orden que hicimos nuestro an√°lisis</p>
<h5 id="caso-2-para-un-formulario-inv√°lido-no-llamamos-al-m√©todo-de-autenticaci√≥n">Caso 2: Para un formulario inv√°lido NO llamamos al m√©todo de autenticaci√≥n</h5>

<p>Resultado esperado</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NO se llama al Auth.signInWithEmailAndPassword
</code></pre></div></div>

<p>la implementaci√≥n de la prueba ser√≠a la siguiente:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">Does not call Auth.signInWithEmailAndPassword if form is not valid</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="nx">mount</span><span class="p">(</span><span class="nx">App</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">vuetify</span><span class="p">:</span> <span class="k">new</span> <span class="nx">Vuetify</span><span class="p">(),</span>
    <span class="nx">store</span><span class="p">,</span>
    <span class="nx">router</span>
  <span class="p">})</span>
  <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">[data-cy=login-btn]</span><span class="dl">'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="dl">'</span><span class="s1">click</span><span class="dl">'</span><span class="p">)</span>
  
  <span class="nx">expect</span><span class="p">(</span><span class="nx">Auth</span><span class="p">.</span><span class="nx">signInWithEmailAndPassword</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toHaveBeenCalled</span><span class="p">()</span>
<span class="p">})</span>
</code></pre></div></div>
<p>Ahora al volver a ejecutar las pruebas vemos como ya hemos abarcado el 100% de los casos para esta vista en la siguiente imagen:</p>

<p><img src="images/07-testing-frontend-03.png" alt="Imagen que muestra cobertura total en el archivo Login.vue" /></p>

<p>Podemos notar que con estas 2 pruebas ya hemos abarcado casi la mitad de lo que hemos construido hasta el momento.
Nuestro enfoque ser√° primero escribir pruebas de ‚Äúalto nivel‚Äù que nos permitan abarcar la mayor cantidad de c√≥digo posible de forma de tener una base de confianza que corrobore que al refactorizar escribiendo c√≥digo mejor estructurado, la funcionalidad general de la aplicaci√≥n se mantenga sin cambios.</p>

<p>El archivo <code class="language-plaintext highlighter-rouge">frontend/tests/unit/Login.spec.js</code> deber√≠a haber quedado de la siguiente forma:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">mount</span><span class="p">,</span> <span class="nx">createLocalVue</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@vue/test-utils</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">Vuetify</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">vuetify</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">flushPromises</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">flush-promises</span><span class="dl">'</span>

<span class="k">import</span> <span class="nx">App</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/App.vue</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">store</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/store</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">router</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/router</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Auth</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/firebase</span><span class="dl">'</span>

<span class="nx">jest</span><span class="p">.</span><span class="nx">mock</span><span class="p">(</span><span class="dl">'</span><span class="s1">@/firebase</span><span class="dl">'</span><span class="p">,()</span><span class="o">=&gt;</span> <span class="p">({</span>
  <span class="na">Auth</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">signInWithEmailAndPassword</span><span class="p">:</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}))</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Login.vue</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">localVue</span>
  <span class="kd">let</span> <span class="nx">vuetify</span>

  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">localVue</span> <span class="o">=</span> <span class="nx">createLocalVue</span><span class="p">()</span>
    <span class="nx">vuetify</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Vuetify</span><span class="p">()</span>

    <span class="nx">router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
    <span class="nx">Auth</span><span class="p">.</span><span class="nx">signInWithEmailAndPassword</span><span class="p">.</span><span class="nx">mockReset</span><span class="p">()</span>
  <span class="p">})</span>

  <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">Successful login redirects to products page</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">Auth</span><span class="p">.</span><span class="nx">signInWithEmailAndPassword</span><span class="p">.</span><span class="nx">mockResolvedValue</span><span class="p">()</span>
    <span class="kd">const</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="nx">mount</span><span class="p">(</span><span class="nx">App</span><span class="p">,{</span>
      <span class="nx">localVue</span><span class="p">,</span>
      <span class="na">vuetify</span><span class="p">:</span> <span class="k">new</span> <span class="nx">Vuetify</span><span class="p">(),</span>
      <span class="nx">store</span><span class="p">,</span>
      <span class="nx">router</span>
    <span class="p">})</span>
    <span class="nx">wrapper</span><span class="p">.</span><span class="nx">vm</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">push</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()</span>
    <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">[data-cy=username]</span><span class="dl">'</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="dl">'</span><span class="s1">testlogin@boolean.cl</span><span class="dl">'</span><span class="p">)</span>
    <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">[data-cy=password]</span><span class="dl">'</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="dl">'</span><span class="s1">somepass</span><span class="dl">'</span><span class="p">)</span>

    <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">[data-cy=login-btn]</span><span class="dl">'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="dl">'</span><span class="s1">click</span><span class="dl">'</span><span class="p">)</span>
    <span class="k">await</span> <span class="nx">flushPromises</span><span class="p">()</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">vm</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">push</span><span class="p">).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Products</span><span class="dl">'</span> <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">Does not call Auth.signInWithEmailAndPassword if form is not valid</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="nx">mount</span><span class="p">(</span><span class="nx">App</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">vuetify</span><span class="p">:</span> <span class="k">new</span> <span class="nx">Vuetify</span><span class="p">(),</span>
      <span class="nx">store</span><span class="p">,</span>
      <span class="nx">router</span>
    <span class="p">})</span>
    <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">[data-cy=login-btn]</span><span class="dl">'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="dl">'</span><span class="s1">click</span><span class="dl">'</span><span class="p">)</span>
    
    <span class="nx">expect</span><span class="p">(</span><span class="nx">Auth</span><span class="p">.</span><span class="nx">signInWithEmailAndPassword</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toHaveBeenCalled</span><span class="p">()</span>
  <span class="p">})</span>
<span class="p">})</span>

</code></pre></div></div>
<h4 id="implementaci√≥n-de-pruebas-sobre-la-vista-products">Implementaci√≥n de pruebas sobre la vista Products</h4>

<p>Pasaremos a hacer las pruebas para productos.</p>

<h5 id="caso-1-al-invocar-a-la-acci√≥n-getproducts-al-inicio-de-la-vista-se-crea-la-lista-de-productos-si-el-servidor-responde-exitosamente">Caso 1: Al invocar a la acci√≥n getProducts al inicio de la vista se crea la lista de productos si el servidor responde exitosamente</h5>

<p>Resultado esperado</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Al resolverse la promesa de axios, la vista agrega los elementos en funci√≥n de la cantidad de productos que provienen del servidor
</code></pre></div></div>

<p>La implementaci√≥n de estas pruebas las escribieremos en un nuevo archivo llamado <code class="language-plaintext highlighter-rouge">Products.spec.js</code> en la carpeta <code class="language-plaintext highlighter-rouge">frontend/tests/unit</code> con el siguiente contenido:</p>

<p><strong>frontend/tests/unit/Products.spec.js</strong></p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">mount</span><span class="p">,</span> <span class="nx">createLocalVue</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@vue/test-utils</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">axios</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">flushPromises</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">flush-promises</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">Vuetify</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">vuetify</span><span class="dl">'</span>

<span class="k">import</span> <span class="nx">App</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/App.vue</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">store</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/store</span><span class="dl">'</span>                  
<span class="k">import</span> <span class="nx">router</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/router</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">products</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../../fixtures/products.json</span><span class="dl">'</span>

<span class="nx">jest</span><span class="p">.</span><span class="nx">mock</span><span class="p">(</span><span class="dl">'</span><span class="s1">axios</span><span class="dl">'</span><span class="p">,()</span> <span class="o">=&gt;</span> <span class="p">({</span>
  <span class="na">get</span><span class="p">:</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()</span>
<span class="p">}))</span>

<span class="nx">jest</span><span class="p">.</span><span class="nx">mock</span><span class="p">(</span><span class="dl">'</span><span class="s1">@/firebase</span><span class="dl">'</span><span class="p">,()</span> <span class="o">=&gt;</span> <span class="p">({</span>
  <span class="na">Auth</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">currentUser</span><span class="p">:</span> <span class="p">{</span> 
      <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">dummyUser</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">getIdToken</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="dl">'</span><span class="s1">fakeToken</span><span class="dl">'</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}))</span>

<span class="nx">describe</span><span class="p">(</span><span class="dl">'</span><span class="s1">Product.vue</span><span class="dl">'</span><span class="p">,()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">localVue</span>
  <span class="kd">let</span> <span class="nx">vuetify</span>

  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">localVue</span> <span class="o">=</span> <span class="nx">createLocalVue</span><span class="p">()</span>
    <span class="nx">vuetify</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Vuetify</span><span class="p">()</span>

    <span class="nx">store</span><span class="p">.</span><span class="nx">replaceState</span><span class="p">({</span>
      <span class="na">products</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">})</span>
    <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">.</span><span class="nx">mockReset</span><span class="p">()</span>
    <span class="nx">router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">Shows a list of products when the server response successfully</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="nx">mount</span><span class="p">(</span><span class="nx">App</span><span class="p">,{</span>
      <span class="nx">localVue</span><span class="p">,</span>
      <span class="nx">vuetify</span><span class="p">,</span>
      <span class="nx">store</span><span class="p">,</span>
      <span class="nx">router</span>
    <span class="p">})</span>
    <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">.</span><span class="nx">mockResolvedValue</span><span class="p">({</span> <span class="na">data</span><span class="p">:</span> <span class="nx">products</span> <span class="p">})</span>
    
    <span class="nx">router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Products</span><span class="dl">'</span> <span class="p">}</span> <span class="p">)</span>
    <span class="k">await</span> <span class="nx">flushPromises</span><span class="p">()</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="dl">'</span><span class="s1">[data-cy=product-item]</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toHaveLength</span><span class="p">(</span><span class="nx">products</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">products</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">products</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">})</span>

</code></pre></div></div>

<p>Nos damos cuenta que las pruebas al igual que en el caso anterior requieren configuraci√≥n como dobles de prueba (1 Mock y 1 Stub) y podemos notar como ahora en el bloque <code class="language-plaintext highlighter-rouge">beforeEach</code> incluimos <code class="language-plaintext highlighter-rouge">store.replaceState</code>. Esto lo deberemos hacer en cada prueba que tenga computada atributos del Store de Vuex para asegurarnos que el estado se reinicia en cada prueba y as√≠ estas se mantienen aisladas entre s√≠ como recordamos en las pruebas de la vista anterior.</p>

<p>Si miramos la prueba notamos que en este caso como la llamada a la acci√≥n de Vuex que desencadena que se configure el valor del estado <code class="language-plaintext highlighter-rouge">products</code> se hace en el m√©todo del ciclo de vida <code class="language-plaintext highlighter-rouge">created</code> del componente, por esto forzamos a que esto ocurra navegando hacia la ruta de la p√°gina de productos a trav√©s del router utilizando <code class="language-plaintext highlighter-rouge">router.push</code></p>

<p>Al correr las pruebas veremos lo que muestra la siguiente imagen:</p>

<p><img src="images/07-testing-frontend-04.png" alt="Imagen que muestra falta de cobertura en store" /></p>

<p>Hemos marcado tambi√©n el store porque sabemos nuestra vista interact√∫a con esta secci√≥n del c√≥digo. Si analizamos el archivo de cobertura asociado a este veremos lo siguiente:</p>

<p><img src="images/07-testing-frontend-05.png" alt="Imagen que muestra falta de cobertura en store" /></p>

<p>Resolveremos esto en el siguiente caso</p>
<h5 id="caso-2-al-invocar-a-la-acci√≥n-getproducts-al-inicio-de-la-vista-no-se-crea-la-lista-de-productos-si-el-servidor-responde-con-error">Caso 2: Al invocar a la acci√≥n getProducts al inicio de la vista NO se crea la lista de productos si el servidor responde con error</h5>

<p>Resultado esperado</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>No se muestran productos en la lista cuando la llamada al servidor responde con error
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">Shows an empty list of products when the server response failed</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="nx">mount</span><span class="p">(</span><span class="nx">App</span><span class="p">,{</span>
    <span class="nx">localVue</span><span class="p">,</span>
    <span class="nx">vuetify</span><span class="p">,</span>
    <span class="nx">store</span><span class="p">,</span>
    <span class="nx">router</span>
  <span class="p">})</span>
  <span class="kd">const</span> <span class="nx">errorMessage</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Database Error in Server</span><span class="dl">'</span>
  <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">.</span><span class="nx">mockRejectedValue</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">errorMessage</span><span class="p">))</span>
  
  <span class="nx">router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Products</span><span class="dl">'</span> <span class="p">}</span> <span class="p">)</span>
  <span class="k">await</span> <span class="nx">flushPromises</span><span class="p">()</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="dl">'</span><span class="s1">[data-cy=product-item]</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toHaveLength</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">products</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">([])</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Ejecutamos las pruebas y veremos como hemos logrado cubrir todo el c√≥digo como muestra la siguiente imagen:</p>

<p><img src="images/07-testing-frontend-06.png" alt="Imagen que muestra cobertura total en store" /></p>

<h4 id="refactorizaci√≥n-del-store">Refactorizaci√≥n del Store</h4>

<p>Con esto ya tenemos una capa de cobertura o caracterizaci√≥n completa del c√≥digo que nos permite implementar la refactorizaci√≥n con mayor confianza. En el caso del framework Vue con Vuex es cl√°sico que el <code class="language-plaintext highlighter-rouge">store</code> es la primera fuente de <em>code smells</em> y tenemos una oportunidad de extraer la llamada al servidor en un servicio independiente. Para esto creamos el directorio <code class="language-plaintext highlighter-rouge">services</code> dentro de <code class="language-plaintext highlighter-rouge">src</code> y ahora crearemos un archivo llamado <code class="language-plaintext highlighter-rouge">product.service.js</code> con el siguiente contenido:</p>

<p><strong>frontend/src/services/product.service.js</strong></p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">axios</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Auth</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/firebase</span><span class="dl">'</span>

<span class="kd">const</span> <span class="nx">productsURL</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">api/products</span><span class="dl">'</span>

<span class="k">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="k">async</span> <span class="nx">getProducts</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Auth</span><span class="p">.</span><span class="nx">currentUser</span><span class="p">?.</span><span class="nx">getIdToken</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
      <span class="kd">const</span> <span class="nx">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">Authorization</span><span class="p">:</span> <span class="s2">`Bearer </span><span class="p">${</span><span class="nx">token</span><span class="p">}</span><span class="s2">`</span>
      <span class="p">}</span>
      <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">productsURL</span><span class="p">,</span> <span class="p">{</span> <span class="nx">headers</span> <span class="p">})</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Productos moment√°neamente no disponibles</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Y en el <code class="language-plaintext highlighter-rouge">store</code> quedar√≠a as√≠:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">Vue</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">vue</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">Vuex</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">vuex</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">productService</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/services/product.service</span><span class="dl">'</span>

<span class="nx">Vue</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">Vuex</span><span class="p">)</span>

<span class="k">export</span> <span class="k">default</span> <span class="k">new</span> <span class="nx">Vuex</span><span class="p">.</span><span class="nx">Store</span><span class="p">({</span>
  <span class="na">state</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">products</span><span class="p">:</span> <span class="p">[]</span>
  <span class="p">},</span>
  <span class="na">mutations</span><span class="p">:</span> <span class="p">{</span>
    <span class="nx">SET_PRODUCTS</span> <span class="p">(</span><span class="nx">store</span><span class="p">,</span> <span class="nx">products</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">store</span><span class="p">.</span><span class="nx">products</span> <span class="o">=</span> <span class="nx">products</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">actions</span><span class="p">:</span> <span class="p">{</span>
    <span class="k">async</span> <span class="nx">getProducts</span> <span class="p">(</span><span class="nx">actionContext</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">commit</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">actionContext</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productService</span><span class="p">.</span><span class="nx">getProducts</span><span class="p">()</span>
        <span class="nx">commit</span><span class="p">(</span><span class="dl">'</span><span class="s1">SET_PRODUCTS</span><span class="dl">'</span><span class="p">,</span> <span class="nx">products</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span>

</code></pre></div></div>

<p>Ahora volvemos a ejecutar las pruebas y veremos que siguen pasando y que a√∫n mantenemos la cobertura como muestra la siguien imagen:</p>

<p><img src="images/07-testing-frontend-07.png" alt="Imagen que muestra cobertura total en store" /></p>

<h4 id="nueva-funcionalidad-a-trav√©s-de-la-metodolog√≠a-tdd">Nueva funcionalidad a trav√©s de la metodolog√≠a TDD</h4>

<p>Escribiremos una nueva funcionalidad para nuestra aplicaci√≥n. Antes de comenzar haremos una simulaci√≥n de como se generar√≠a la necesidad de programar algo nuevo en una aplicaci√≥n si estuvieramos en el caso de una aplicaci√≥n en la que hay un equipo multidisciplinario involucrado comenzando desde quienes solicitan el cambio hasta como lo hace el programador para describir lo que tiene que hacer y aprovecharemos esto para aplicar la metodolod√≠a TDD: Desarrollo guiado por pruebas</p>

<p><strong>Descripci√≥n de la soluci√≥n de alto nivel</strong></p>

<blockquote>
  <p>Crear una alerta centralizada para toda la aplicaci√≥n que debe mostrar informaci√≥n tanto de √©xito como de error manteniendo el estilo visual actual</p>
</blockquote>

<p>El texto anterior surge de una coordinaci√≥n entre personas del √°rea de UI, UX, Desarrolladores y roles de negocio en una empresa y que termina en manos de los programadores que debemos ser capaces de implementar estos requerimientos a partir de nuestro conocimientos en la tecnolog√≠a que est√° escrita nuestra aplicaci√≥n.</p>

<p>Cuando nos enfrentamos al desaf√≠o de implementar esta funcionalidad gracias a nuestro conocimiento en programaci√≥n, conocimiento del Framework Vue y entendiendo como funciona el patr√≥n de manejo de estados de Vuex, podr√≠amos refinar m√°s el requerimiento ahora en t√©rminos t√©cnicos</p>

<p><strong>Descripci√≥n t√©cnica</strong></p>

<blockquote>
  <p>Lo que haremos ser√° escribir un componente que nos permita mostrar una alerta central que se activar√° a partir de una propiedad que configuraremos en el store.
Para mostrar la alerta de forma central la agregaremos al componente App.vue que se conectar√° al estado y mostrar√° o no la alerta en funci√≥n de si est√° la alerta o no asignada. El valor del estado lo llamaremos <code class="language-plaintext highlighter-rouge">alert</code> y su valor por defecto ser√° <code class="language-plaintext highlighter-rouge">null</code>.
Para poder asignar una alerta en el estado expondremos una acci√≥n llamada setAlert para estos fines.
En cuanto a la UI utilizaremos el componente <code class="language-plaintext highlighter-rouge">&lt;v-alert&gt;</code> que trae Vuetify y modelaremos la alerta como un objeto que tenga las propiedades <code class="language-plaintext highlighter-rouge">message</code> y <code class="language-plaintext highlighter-rouge">type</code>.</p>
</blockquote>

<p>Si bien podemos tener una estrategia en mente y entender los conceptos de arquitectura del framework, tener ideas por sobre como resolverlo y probar todo esto directamente en la aplicaci√≥n, lo que haremos ser√° modificar nuestras pruebas para hacerlas fallar debido a que consultaremos sobre cosas que a√∫n no est√°n programadas y relacionadas a esta funcionalidad.</p>

<h5 id="modo-tdd">Modo TDD</h5>

<p>Lo primero ser√° agregar un nuevo script al archivo <code class="language-plaintext highlighter-rouge">frontend/package.json</code> en la secci√≥n correspondiente de la siguiente forma</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="dl">"</span><span class="s2">tdd</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">npm run test:unit -- --watchAll</span><span class="dl">"</span>
</code></pre></div></div>

<p>Ahora ejecutamos el comando <code class="language-plaintext highlighter-rouge">npm run tdd</code> y veremos algo como en la siguiente imagen:</p>

<p><img src="images/07-testing-frontend-08.png" alt="Imagen que muestra modo tdd de jest" /></p>

<p>Vemos que ahora la terminal est√° esperando que se hagan cambios ya sea en las pruebas o en el c√≥digo fuente.</p>

<h4 id="implementaci√≥n-de-la-alerta-cuando-falla-autenticaci√≥n-en-vista-login">Implementaci√≥n de la alerta cuando falla autenticaci√≥n en vista Login</h4>

<p>Comenzaremos por modificar las pruebas que ya hab√≠amos escrito y as√≠ hacerlas fallar. Agregaremos una nueva prueba para la vista Login</p>

<p><strong>frontend/tests/unit/Login.spec.js</strong></p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">Login failed shows global alert</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="nx">mount</span><span class="p">(</span><span class="nx">App</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">localVue</span><span class="p">,</span>
    <span class="nx">vuetify</span><span class="p">,</span>
    <span class="nx">store</span><span class="p">,</span>
    <span class="nx">router</span>
  <span class="p">})</span>
  <span class="kd">const</span> <span class="nx">errorMessage</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Invalid user</span><span class="dl">'</span>
  <span class="nx">Auth</span><span class="p">.</span><span class="nx">signInWithEmailAndPassword</span><span class="p">.</span><span class="nx">mockRejectedValue</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">errorMessage</span><span class="p">))</span>
  <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">[data-cy=username]</span><span class="dl">'</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="dl">'</span><span class="s1">sebastian@boolean.cl</span><span class="dl">'</span><span class="p">)</span>
  <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">[data-cy=password]</span><span class="dl">'</span><span class="p">).</span><span class="nx">setValue</span><span class="p">(</span><span class="dl">'</span><span class="s1">academiaboolean</span><span class="dl">'</span><span class="p">)</span>
  
  <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">[data-cy=login-btn]</span><span class="dl">'</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="dl">'</span><span class="s1">click</span><span class="dl">'</span><span class="p">)</span>
  <span class="k">await</span> <span class="nx">flushPromises</span><span class="p">()</span>

  <span class="kd">const</span> <span class="nx">expectedMessage</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Error al hacer autenticaci√≥n</span><span class="dl">'</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">[role=alert]</span><span class="dl">'</span><span class="p">).</span><span class="nx">text</span><span class="p">()).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expectedMessage</span><span class="p">)</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">alert</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">({</span>
    <span class="na">message</span><span class="p">:</span> <span class="nx">expectedMessage</span><span class="p">,</span>
    <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">error</span><span class="dl">'</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>
<p>Al actualizarse las pruebas veremos un error como muestra la siguiente imagen:</p>

<p><img src="images/07-testing-frontend-09.png" alt="Imagen que muestra error en la terminal" /></p>

<p>Esto ocurre porque en la vista Login no capturamos las excepciones cuando ocurre un error en la funci√≥n <code class="language-plaintext highlighter-rouge">Auth.signInWithEmailAndPassword</code>. Vamos a modificar esta vista en el archivo <code class="language-plaintext highlighter-rouge">frontend/src/views/Login.vue</code> reemplazando la funci√≥n <code class="language-plaintext highlighter-rouge">login</code> por lo siguiente:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="nx">login</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">validate</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nx">Auth</span><span class="p">.</span><span class="nx">signInWithEmailAndPassword</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Products</span><span class="dl">'</span> <span class="p">})</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Ahora al recargarse las pruebas veremos que el error ha cambiado a lo que muestra la siguiente imagen:</p>

<p><img src="images/07-testing-frontend-10.png" alt="Imagen que muestra error en prueba" /></p>

<p>Como vimos en unos de los cap√≠tulos anteriores, lo que deber√≠amos hacer es escribir el c√≥digo m√°s simple posible que que sea capaz se hacer pasar la prueba y luego refactorizar. En este caso como la prueba est√° fallando agregaremos en la secci√≥n <code class="language-plaintext highlighter-rouge">template</code> el c√≥digo m√°s simple posible que logre resolver esta prueba:</p>

<p><strong>frontend/src/views/Login.vue</strong></p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;template&gt;</span>
  <span class="nt">&lt;v-main</span> <span class="na">class=</span><span class="s">"home"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">role=</span><span class="s">"alert"</span><span class="nt">&gt;</span>
      Error al hacer autenticaci√≥n
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;v-card</span> <span class="na">width=</span><span class="s">"400px"</span> <span class="na">class=</span><span class="s">"mx-auto my-auto"</span><span class="nt">&gt;</span>
    ...
    <span class="nt">&lt;/v-card&gt;</span>
  <span class="nt">&lt;/v-main&gt;</span>
<span class="nt">&lt;/template&gt;</span>
</code></pre></div></div>
<p>Ahora al recargarse las pruebas vemos que el error ha cambiado:</p>

<p><img src="images/07-testing-frontend-11.png" alt="Imagen que muestra error en prueba" /></p>

<p>Y tal como lo hicimos en el caso anterior escribiremos el c√≥digo m√°s simple posible para pasar esta prueba. esto ser√≠a modificar el store en la propiedad <code class="language-plaintext highlighter-rouge">state</code> con el siguiente c√≥digo:</p>

<p><strong>frontend/src/store/index.js</strong></p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>

<span class="k">export</span> <span class="k">default</span> <span class="k">new</span> <span class="nx">Vuex</span><span class="p">.</span><span class="nx">Store</span><span class="p">({</span>
  <span class="na">state</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">products</span><span class="p">:</span> <span class="p">[],</span>
    <span class="na">alert</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Error al hacer autenticaci√≥n</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">error</span><span class="dl">'</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">...</span>

<span class="p">})</span>

</code></pre></div></div>
<p>Con este √∫ltimo cambio al recargarse las pruebas vemos que est√°n pasando todas.</p>

<h5 id="refactorizaci√≥n">Refactorizaci√≥n</h5>

<p>Ahora haremos algunos cambios para que nuestro c√≥digo sea dise√±ado como hab√≠amos descrito en la definici√≥n t√©cnica.</p>

<p>Primero vamos a reemplazar completamente la secci√≥n <code class="language-plaintext highlighter-rouge">script</code> para que quede de la siguiente manera:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">mapActions</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">vuex</span><span class="dl">'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Auth</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/firebase</span><span class="dl">'</span>

<span class="k">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="nx">data</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">email</span><span class="p">:</span> <span class="dl">''</span><span class="p">,</span>
      <span class="na">emailRules</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">!!</span><span class="nx">v</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">El correo es requerido</span><span class="dl">'</span><span class="p">,</span>
        <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="sr">/.+@.+</span><span class="se">\.</span><span class="sr">.+/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">El correo debe tener formato v√°lido</span><span class="dl">'</span>
      <span class="p">],</span>
      <span class="na">password</span><span class="p">:</span> <span class="dl">''</span><span class="p">,</span>
      <span class="na">passwordRules</span><span class="p">:</span> <span class="p">[(</span><span class="nx">v</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">!!</span><span class="nx">v</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">La contrase√±a es requerida</span><span class="dl">'</span><span class="p">],</span>
      <span class="na">showPassword</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">methods</span><span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span><span class="nx">mapActions</span><span class="p">([</span><span class="dl">'</span><span class="s1">setAlert</span><span class="dl">'</span><span class="p">]),</span>
    <span class="nx">validate</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">$refs</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">validate</span><span class="p">()</span>
    <span class="p">},</span>
    <span class="k">async</span> <span class="nx">login</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">validate</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="k">await</span> <span class="nx">Auth</span><span class="p">.</span><span class="nx">signInWithEmailAndPassword</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">$router</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Products</span><span class="dl">'</span> <span class="p">})</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">setAlert</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Error al hacer autenticaci√≥n</span><span class="dl">'</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">error</span><span class="dl">'</span> <span class="p">})</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>

</code></pre></div></div>
<p>Si bien las pruebas siguen pasando podemos ver un mensaje de error que dice lo siguiente</p>

<blockquote>
  <p>console.error node_modules/vuex/dist/vuex.common.js:499
  [vuex] unknown action type: setAlert</p>
</blockquote>

<p>Esto nos est√° diciendo que estamos tratando de mapear una acci√≥n que no existe. Para esto iremos al archivo <code class="language-plaintext highlighter-rouge">frontend/src/store/index.js</code> y lo reemplazaremos completamente con lo siguiente:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">Vue</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">vue</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">Vuex</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">vuex</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">productService</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/services/product.service</span><span class="dl">'</span>

<span class="nx">Vue</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">Vuex</span><span class="p">)</span>

<span class="k">export</span> <span class="k">default</span> <span class="k">new</span> <span class="nx">Vuex</span><span class="p">.</span><span class="nx">Store</span><span class="p">({</span>
  <span class="na">state</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">products</span><span class="p">:</span> <span class="p">[],</span>
    <span class="na">alert</span><span class="p">:</span> <span class="kc">null</span>
  <span class="p">},</span>
  <span class="na">mutations</span><span class="p">:</span> <span class="p">{</span>
    <span class="nx">SET_PRODUCTS</span> <span class="p">(</span><span class="nx">store</span><span class="p">,</span> <span class="nx">products</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">store</span><span class="p">.</span><span class="nx">products</span> <span class="o">=</span> <span class="nx">products</span>
    <span class="p">},</span>
    <span class="nx">SET_ALERT</span> <span class="p">(</span><span class="nx">store</span><span class="p">,</span> <span class="nx">alert</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">store</span><span class="p">.</span><span class="nx">alert</span> <span class="o">=</span> <span class="nx">alert</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">actions</span><span class="p">:</span> <span class="p">{</span>
    <span class="k">async</span> <span class="nx">getProducts</span> <span class="p">(</span><span class="nx">actionContext</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">commit</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">actionContext</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productService</span><span class="p">.</span><span class="nx">getProducts</span><span class="p">()</span>
        <span class="nx">commit</span><span class="p">(</span><span class="dl">'</span><span class="s1">SET_PRODUCTS</span><span class="dl">'</span><span class="p">,</span> <span class="nx">products</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">setAlert</span> <span class="p">(</span><span class="nx">actionContext</span><span class="p">,</span> <span class="nx">alert</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="p">{</span> <span class="nx">commit</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">actionContext</span>
      <span class="nx">commit</span><span class="p">(</span><span class="dl">'</span><span class="s1">SET_ALERT</span><span class="dl">'</span><span class="p">,</span> <span class="nx">alert</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">})</span>

</code></pre></div></div>
<p>Vemos que al recargarse las pruebas estas siguen pasando. Ahora modificaremos el archivo <code class="language-plaintext highlighter-rouge">src/App.vue</code> para agregar la alerta global. Y lo reemplazamos por lo siguiente:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;template&gt;</span>
  <span class="nt">&lt;v-app&gt;</span>
    <span class="nt">&lt;v-main&gt;</span>
      <span class="nt">&lt;v-alert</span>
        <span class="na">v-if=</span><span class="s">"alert"</span>
        <span class="na">class=</span><span class="s">"text-center"</span>
        <span class="na">:type=</span><span class="s">"alert.type"</span>
        <span class="na">dismissible</span>
        <span class="na">outlined</span>
        <span class="na">border=</span><span class="s">"left"</span>
        <span class="err">@</span><span class="na">input=</span><span class="s">"closeAlert"</span>
      <span class="nt">&gt;</span>
        
      <span class="nt">&lt;/v-alert&gt;</span>
      <span class="nt">&lt;router-view&gt;&lt;/router-view&gt;</span>
    <span class="nt">&lt;/v-main&gt;</span>
  <span class="nt">&lt;/v-app&gt;</span>
<span class="nt">&lt;/template&gt;</span>

<span class="nt">&lt;script&gt;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">mapActions</span><span class="p">,</span> <span class="nx">mapState</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">vuex</span><span class="dl">'</span>

<span class="k">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">App</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">computed</span><span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span><span class="nx">mapState</span><span class="p">([</span> <span class="dl">'</span><span class="s1">alert</span><span class="dl">'</span> <span class="p">])</span>
  <span class="p">},</span>
  <span class="na">methods</span><span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span><span class="nx">mapActions</span><span class="p">([</span><span class="dl">'</span><span class="s1">setAlert</span><span class="dl">'</span><span class="p">]),</span>
    <span class="nx">closeAlert</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setAlert</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>

</code></pre></div></div>
<p>Una buena oportunidad de separaci√≥n de responsabilidades ser√≠a extraer la alerta a su propio componente y mediante <code class="language-plaintext highlighter-rouge">props</code> pasar las propiedades reactivas desde el componente <code class="language-plaintext highlighter-rouge">App.vue</code> al <code class="language-plaintext highlighter-rouge">AppAlert.vue</code> que crearemos ahora. Para eso creamos el componente <code class="language-plaintext highlighter-rouge">src/components/AppAlert.vue</code> con el siguiente contenido:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nx">v</span><span class="o">-</span><span class="nx">alert</span>
    <span class="kd">class</span><span class="o">=</span><span class="dl">"</span><span class="s2">text-center</span><span class="dl">"</span>
    <span class="p">:</span><span class="nx">type</span><span class="o">=</span><span class="dl">"</span><span class="s2">type</span><span class="dl">"</span>
    <span class="nx">dismissible</span>
    <span class="nx">outlined</span>
    <span class="nx">border</span><span class="o">=</span><span class="dl">"</span><span class="s2">left</span><span class="dl">"</span>
    <span class="p">@</span><span class="nd">input</span><span class="o">=</span><span class="dl">"</span><span class="s2">closeAlert</span><span class="dl">"</span>
  <span class="o">&gt;</span>
  
  <span class="o">&lt;</span><span class="sr">/v-alert</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/template</span><span class="err">&gt;
</span>
<span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
<span class="k">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="na">props</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">message</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
      <span class="na">default</span><span class="p">:</span> <span class="dl">''</span>
    <span class="p">},</span>
    <span class="na">type</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
      <span class="na">default</span><span class="p">:</span> <span class="dl">'</span><span class="s1">error</span><span class="dl">'</span>
    <span class="p">},</span>
    <span class="na">closeAlert</span><span class="p">:</span> <span class="nb">Function</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span>
</code></pre></div></div>
<p>Ahora con los cambios necesarios en el <code class="language-plaintext highlighter-rouge">App.vue</code>, quedar√≠a de la siguiente forma:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">template</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nx">v</span><span class="o">-</span><span class="nx">app</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">v</span><span class="o">-</span><span class="nx">main</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">app</span><span class="o">-</span><span class="nx">alert</span> 
        <span class="nx">v</span><span class="o">-</span><span class="k">if</span><span class="o">=</span><span class="dl">"</span><span class="s2">alert</span><span class="dl">"</span>
        <span class="p">:</span><span class="nx">message</span><span class="o">=</span><span class="dl">"</span><span class="s2">alert.message</span><span class="dl">"</span>
        <span class="p">:</span><span class="nx">type</span><span class="o">=</span><span class="dl">"</span><span class="s2">alert.type</span><span class="dl">"</span>
        <span class="p">:</span><span class="nx">closeAlert</span><span class="o">=</span><span class="dl">"</span><span class="s2">closeAlert</span><span class="dl">"</span>
      <span class="o">/&gt;</span>
      <span class="o">&lt;</span><span class="nx">router</span><span class="o">-</span><span class="nx">view</span><span class="o">&gt;&lt;</span><span class="sr">/router-view</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="sr">/v-main</span><span class="err">&gt;
</span>  <span class="o">&lt;</span><span class="sr">/v-app</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/template</span><span class="err">&gt;
</span>
<span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">mapActions</span><span class="p">,</span> <span class="nx">mapState</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">vuex</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">AppAlert</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/components/AppAlert</span><span class="dl">'</span>

<span class="k">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">App</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">components</span><span class="p">:</span> <span class="p">{</span>
    <span class="nx">AppAlert</span>
  <span class="p">},</span>
  <span class="na">computed</span><span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span><span class="nx">mapState</span><span class="p">([</span> <span class="dl">'</span><span class="s1">alert</span><span class="dl">'</span> <span class="p">])</span>
  <span class="p">},</span>
  <span class="na">methods</span><span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span><span class="nx">mapActions</span><span class="p">([</span><span class="dl">'</span><span class="s1">setAlert</span><span class="dl">'</span><span class="p">]),</span>
    <span class="nx">closeAlert</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setAlert</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre></div></div>

<p>Ahora quitaremos el c√≥digo HTML que agregamos a la vista Login en la secci√≥n <code class="language-plaintext highlighter-rouge">template</code> y veremos que nuestras pruebas contin√∫an pasando a pesar de toda la refactorizaci√≥n que hemos hecho.</p>

<h4 id="implementaci√≥n-de-la-alerta-cuando-falla-el-servidor-en-vista-products">Implementaci√≥n de la alerta cuando falla el servidor en vista Products</h4>

<p>Ahora modificaremos la prueba que escribimos para el caso que el servidor falla agregando dos nuevas sentencias <code class="language-plaintext highlighter-rouge">expect</code> a la prueba ya escrita. Reemplazamos por el siguiente c√≥digo</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">Shows an empty list of products when the server response failed</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="nx">mount</span><span class="p">(</span><span class="nx">App</span><span class="p">,{</span>
    <span class="nx">localVue</span><span class="p">,</span>
    <span class="nx">vuetify</span><span class="p">,</span>
    <span class="nx">store</span><span class="p">,</span>
    <span class="nx">router</span>
  <span class="p">})</span>
  <span class="kd">const</span> <span class="nx">errorMessage</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Database Error in Server</span><span class="dl">'</span>
  <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">.</span><span class="nx">mockRejectedValue</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">errorMessage</span><span class="p">))</span>
  
  <span class="nx">router</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Products</span><span class="dl">'</span> <span class="p">})</span>
  <span class="k">await</span> <span class="nx">flushPromises</span><span class="p">()</span>

  <span class="kd">const</span> <span class="nx">expectedMessage</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">Productos moment√°neamente no disponibles</span><span class="dl">'</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="dl">'</span><span class="s1">[data-cy=product-item]</span><span class="dl">'</span><span class="p">)).</span><span class="nx">toHaveLength</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">products</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">([])</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="dl">'</span><span class="s1">[role=alert]</span><span class="dl">'</span><span class="p">).</span><span class="nx">text</span><span class="p">()).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">expectedMessage</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p><img src="images/07-testing-frontend-12.png" alt="Imagen que muestra error en prueba" /></p>

<p>Esta vez el c√≥digo m√°s simple posible para resolver esta prueba no es agregar el HTML de forma est√°tica, porque ya hemos construido nuestra alerta global. Lo √∫nico que nos falta es agregar esta alerta cuando detectamos que el servidor al momento de obtener los productos falle.
Modificaremos el archivo <code class="language-plaintext highlighter-rouge">frontend/src/store/index.js</code> en la funci√≥n <code class="language-plaintext highlighter-rouge">getProducts</code> para que quede como muestra el siguiente c√≥digo:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="p">...</span>
<span class="k">async</span> <span class="nx">getProducts</span> <span class="p">(</span><span class="nx">actionContext</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">commit</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">actionContext</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">productService</span><span class="p">.</span><span class="nx">getProducts</span><span class="p">()</span>
    <span class="nx">commit</span><span class="p">(</span><span class="dl">'</span><span class="s1">SET_PRODUCTS</span><span class="dl">'</span><span class="p">,</span> <span class="nx">products</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">commit</span><span class="p">(</span><span class="dl">'</span><span class="s1">SET_ALERT</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">error</span><span class="dl">'</span> <span class="p">})</span>
  <span class="p">}</span>
<span class="p">},</span>
<span class="p">...</span>

</code></pre></div></div>

<p>Vemos que la prueba sigue fallando. Esto es porque para mantener cada una de las pruebas aisladas antes de cada prueba estamos creando un estado inicial para el store y actualmente no incluye el valor <code class="language-plaintext highlighter-rouge">alert</code>. Iremos a modificar el bloque <code class="language-plaintext highlighter-rouge">beforeEach</code> y lo reemplazaremos por lo siguiente:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="p">...</span>
<span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">localVue</span> <span class="o">=</span> <span class="nx">createLocalVue</span><span class="p">()</span>
  <span class="nx">vuetify</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Vuetify</span><span class="p">()</span>

  <span class="nx">store</span><span class="p">.</span><span class="nx">replaceState</span><span class="p">({</span>
    <span class="na">products</span><span class="p">:</span> <span class="p">[],</span>
    <span class="na">alert</span><span class="p">:</span> <span class="kc">null</span>
  <span class="p">})</span>
  <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">.</span><span class="nx">mockReset</span><span class="p">()</span>
  <span class="nx">router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
<span class="p">})</span>
<span class="p">...</span>
</code></pre></div></div>

<p>Luego de hacer este cambio las pruebas se recargar√°n y podemos ver como est√°n pasando todas una vez m√°s.</p>

<p><img src="images/07-testing-frontend-13.png" alt="Despu√©s del refactor y tdd" /></p>

<h4 id="probar-la-aplicaci√≥n-con-servidor-y-frontend-corriendo">Probar la aplicaci√≥n con servidor y frontend corriendo</h4>
<p>Ahora probaremos la aplicaci√≥n manualmente corriendo el comando <code class="language-plaintext highlighter-rouge">npm run serve</code> y en otra ventana corriendo <code class="language-plaintext highlighter-rouge">npm run dev</code> en Frontend y Backend respectivamente. Como en la siguiente imagen:</p>

<p><img src="images/07-testing-frontend-14.png" alt="corriedo dos terminales" /></p>

<p>Y podemos ver c√≥mo en la UI tenemos la alerta funcionando:</p>

<p><img src="images/07-testing-frontend-15.png" alt="corriedo dos terminales" /></p>

<p>Momento de un nuevo commit. Agrega lo siguiente desde la ra√≠z del proyecto</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git add <span class="nb">.</span>
git commit <span class="nt">-m</span> <span class="s2">"refactor(frontend-refactor): Se agreg√≥ set de pruebas de caracterizaci√≥n en el Frontend y luego un refactor para dividir responsabilidades. Adem√°s se trabajo alerta global con TDD"</span>
</code></pre></div></div>

<table>
  <tr>
    <th colspan="2">
      <a href="./06-testing-backend.md">
        <span>‚¨ÖÔ∏è </span>
       Refactorizaci√≥n utilizando pruebas de software en Backend
      </a>
    </th>
    <th colspan="2">
      <a href="./08-development-workflow-husky.md"> Flujo de desarrollo del proyecto
        <span>‚û°Ô∏è </span>
      </a>
    </th>
  </tr>
</table>

:ET